(window.webpackJsonp=window.webpackJsonp||[]).push([[223],{664:function(s,a,r){"use strict";r.r(a);var t=r(16),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,r=s._self._c||a;return r("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[r("h1",{attrs:{id:"redis-cluster-集群"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#redis-cluster-集群"}},[s._v("#")]),s._v(" Redis Cluster 集群")]),s._v(" "),r("p",[s._v("主要是以多主多从的集群方式来保证高可用高并发。")]),s._v(" "),r("div",{staticClass:"language-mermaid line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-mermaid"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　user "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" master1"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　user "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" master2"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　user "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" master3"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　master1 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" slave1\n　　master2 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" slave2\n　　master3 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" slave3\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br"),r("span",{staticClass:"line-number"},[s._v("4")]),r("br"),r("span",{staticClass:"line-number"},[s._v("5")]),r("br"),r("span",{staticClass:"line-number"},[s._v("6")]),r("br"),r("span",{staticClass:"line-number"},[s._v("7")]),r("br")])]),r("h2",{attrs:{id:"特点"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#特点"}},[s._v("#")]),s._v(" 特点")]),s._v(" "),r("ul",[r("li",[s._v("无中心的结构，数据分散在各个节点上，并且保存了整个集群的状态，每个节点都和其他节点相连")]),s._v(" "),r("li",[s._v("官方规定最小需要 6 个节点，3 个主节点和 3 个从节点")]),s._v(" "),r("li",[s._v("各个节点是通过"),r("code",[s._v("gossip")]),s._v("协议交换数据的，数据分布采用哈希槽算法实现，有一个"),r("code",[s._v("crc16(key) % 16384")]),s._v("取模的"),r("code",[s._v("redis key")]),s._v("路由公式。")])]),s._v(" "),r("div",{staticClass:"language-mermaid line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-mermaid"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　user "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" 0-5460哈希槽1"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　user "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" 5461-10922哈希槽2"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　user "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" 10923-16383哈希槽3"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　0-5460哈希槽1 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" 节点1\n　　5461-10922哈希槽2 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" 节点2\n　　10923-16383哈希槽3 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" 节点3\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br"),r("span",{staticClass:"line-number"},[s._v("4")]),r("br"),r("span",{staticClass:"line-number"},[s._v("5")]),r("br"),r("span",{staticClass:"line-number"},[s._v("6")]),r("br"),r("span",{staticClass:"line-number"},[s._v("7")]),r("br")])]),r("div",{staticClass:"custom-block tip"},[r("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),r("p",[r("code",[s._v("crc16")]),s._v("算法的"),r("code",[s._v("hash")]),s._v("值最大是 65535，为什么不创建 65535 个槽位呢？")]),s._v(" "),r("blockquote",[r("p",[r("code",[s._v("redis")]),s._v("节点发送的心跳包需要把所有的槽位信息放到心跳包中，方便节点知道集群信息；压缩以后大小是 2k；虽然最大 65535 压缩为 8k，作者认为 8k 的心跳包浪费，一般一个 redis 集群也不会超过 1000 个 master 节点，所以 16384 是比较合适的。")])])]),s._v(" "),r("h2",{attrs:{id:"gossip-协议"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#gossip-协议"}},[s._v("#")]),s._v(" gossip 协议")]),s._v(" "),r("p",[r("code",[s._v("Gossip")]),s._v("协议，就像流言蜚语一样，利用一种随机性、带有传染性的方式，将信息传播到整个网络中，并在一定时间内，使得系统内的所有节点数据一致。实现最终一致性。")]),s._v(" "),r("p",[s._v("所有节点都持有一份元数据，不同的节点如果出现了元数据变更以后，就不断的将元数据发送给其他节点，让其他节点也进行元数据的变更。")]),s._v(" "),r("ul",[r("li",[s._v("优点：元数据的更新比较分散，没有集中在一个点，更新会陆续的到所有的节点，因为有一定的延时，所以会降低压力。")]),s._v(" "),r("li",[s._v("缺点：有延迟性，导致一些操作会滞后")])]),s._v(" "),r("h3",{attrs:{id:"通信"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#通信"}},[s._v("#")]),s._v(" 通信")]),s._v(" "),r("p",[s._v("每个节点都会维护一份集群的状态")]),s._v(" "),r("ul",[r("li",[s._v("当前集群的状态")]),s._v(" "),r("li",[s._v("集群中各节点负责的"),r("code",[s._v("slots")]),s._v("信息和"),r("code",[s._v("migrate")]),s._v("状态")]),s._v(" "),r("li",[s._v("集群中各节点的"),r("code",[s._v("master")]),s._v("和"),r("code",[s._v("slave")]),s._v("状态")]),s._v(" "),r("li",[s._v("集群中各节点存货状态和怀疑"),r("code",[s._v("Fail")]),s._v("状态")])]),s._v(" "),r("p",[s._v("四种命令：")]),s._v(" "),r("ul",[r("li",[s._v("MEET：通过"),r("code",[s._v("cluster meet ip port")]),s._v("命令，已有集群的节点会向新的节点发送邀请，加入现有集群，然后新节点就会开始与其他节点进行通信")]),s._v(" "),r("li",[s._v("PING：节点按照配置的时间间隔向集群中其他节点发送"),r("code",[s._v("ping")]),s._v("消息，消息中带有自己的状态，还有自己维护的集群元数据，和部分其他节点的元数据")]),s._v(" "),r("li",[s._v("PONG：节点用于回应"),r("code",[s._v("PING")]),s._v("和"),r("code",[s._v("MEET")]),s._v("的消息，结构和"),r("code",[s._v("PING")]),s._v("消息类似 ，也包含自己的状态和其他信息，也可以用于信息广播和更新")]),s._v(" "),r("li",[s._v("FAIL：节点"),r("code",[s._v("PING")]),s._v("不通某节点后，会向集群所有节点广播该节点挂掉的消息。其他节点收到消息后标记已下线。")])]),s._v(" "),r("div",{staticClass:"language-mermaid line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-mermaid"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　节点1 "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("ping 消息")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" 节点2\n　　节点2 "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("pong 消息")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" 节点1\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br")])]),r("div",{staticClass:"language-mermaid line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-mermaid"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\tA"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(cluster meet ip port)")]),s._v("\n\t节点1 "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("ping 消息")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" 新节点\n\t新节点 "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("pong 消息")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" 节点1\n\t节点1 "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("ping 消息")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" 新节点\n\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br"),r("span",{staticClass:"line-number"},[s._v("4")]),r("br"),r("span",{staticClass:"line-number"},[s._v("5")]),r("br"),r("span",{staticClass:"line-number"},[s._v("6")]),r("br")])]),r("div",{staticClass:"language-mermaid line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-mermaid"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\tA"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(节点1)")]),s._v("\n\tB"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(节点2)")]),s._v("\n\tC"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(未收到pong消息设置节点2为Pfail)")]),s._v("\n\tD"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(节点3)")]),s._v("\n\tA "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("ping 消息")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" B\n\tB "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("X")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" C\n\tA "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("ping 消息 告诉其他节点把节点2标记为Pfail了")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" D\n\tD "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("pong 消息 记录下节点1在xxx时间把节点2标记为Pfail了")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" A\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br"),r("span",{staticClass:"line-number"},[s._v("4")]),r("br"),r("span",{staticClass:"line-number"},[s._v("5")]),r("br"),r("span",{staticClass:"line-number"},[s._v("6")]),r("br"),r("span",{staticClass:"line-number"},[s._v("7")]),r("br"),r("span",{staticClass:"line-number"},[s._v("8")]),r("br"),r("span",{staticClass:"line-number"},[s._v("9")]),r("br")])]),r("div",{staticClass:"language-mermaid line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-mermaid"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\tA"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(节点10 标记节点2为下线状态)")]),s._v("\n\tB"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(节点1)")]),s._v("\n\tC"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(节点3)")]),s._v("\n\tD"),r("span",{pre:!0,attrs:{class:"token text string"}},[s._v("(节点n 其他节点设置节点2的状态为下线)")]),s._v("\n\tA "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("ping消息告诉其他节点 节点2已下线")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" B\n\tA "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("ping消息告诉其他节点 节点2已下线")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" C\n\tA "),r("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[r("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[s._v("--")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token label property"}},[s._v("ping消息告诉其他节点 节点2已下线")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")])]),s._v(" D\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br"),r("span",{staticClass:"line-number"},[s._v("4")]),r("br"),r("span",{staticClass:"line-number"},[s._v("5")]),r("br"),r("span",{staticClass:"line-number"},[s._v("6")]),r("br"),r("span",{staticClass:"line-number"},[s._v("7")]),r("br"),r("span",{staticClass:"line-number"},[s._v("8")]),r("br")])]),r("h2",{attrs:{id:"redis-cluster-集群架构"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#redis-cluster-集群架构"}},[s._v("#")]),s._v(" Redis Cluster 集群架构")]),s._v(" "),r("p",[s._v("常用集群架构图")]),s._v(" "),r("div",{staticClass:"language-mermaid line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-mermaid"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　user "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" master1"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　user "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" master2"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　user "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" master3"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n　　master1 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" slave1\n　　master1 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" slave4\n　　master2 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" slave2\n　　master2 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" slave5\n　　master3 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" slave3\n　　master3 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" slave6\n　　master1 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("-.-")]),s._v(" master2\n　　master2 "),r("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("-.-")]),s._v(" master3\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br"),r("span",{staticClass:"line-number"},[s._v("4")]),r("br"),r("span",{staticClass:"line-number"},[s._v("5")]),r("br"),r("span",{staticClass:"line-number"},[s._v("6")]),r("br"),r("span",{staticClass:"line-number"},[s._v("7")]),r("br"),r("span",{staticClass:"line-number"},[s._v("8")]),r("br"),r("span",{staticClass:"line-number"},[s._v("9")]),r("br"),r("span",{staticClass:"line-number"},[s._v("10")]),r("br"),r("span",{staticClass:"line-number"},[s._v("11")]),r("br"),r("span",{staticClass:"line-number"},[s._v("12")]),r("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);