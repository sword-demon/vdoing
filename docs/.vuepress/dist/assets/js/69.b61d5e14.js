(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{511:function(s,t,a){"use strict";a.r(t);var e=a(16),v=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"分布式事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务"}},[s._v("#")]),s._v(" 分布式事务")]),s._v(" "),a("p",[s._v("讲到事务，基本就是经典的转账问题")]),s._v(" "),a("p",[s._v("支付宝账户表："),a("code",[s._v("A(id, user_id, amount)")])]),s._v(" "),a("p",[s._v("余额宝账户表："),a("code",[s._v("B(id, user_id, amount)")])]),s._v(" "),a("p",[s._v("用户的"),a("code",[s._v("user_id = 1")]),s._v("，从支付宝转账 1 万到余额宝分为 2 个步骤：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("支付宝表扣除 1 万：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" A "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" amount "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" amount "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" user_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("余额宝表增加 1 万：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" B "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" amount "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" amount "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" user_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])]),s._v(" "),a("p",[a("strong",[s._v("如何保证一致性呢？")])]),s._v(" "),a("blockquote",[a("p",[s._v("单个数据库，我们保证"),a("code",[s._v("ACID")]),s._v("使用数据库事务")])]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("随着系统变大，进行了微服务架构的改造，因为每个微服务独占了一个数据库实例，从"),a("code",[s._v("user_id = 1")]),s._v("发起的转账动作，跨越了两个微服务："),a("code",[s._v("pay")]),s._v("和"),a("code",[s._v("balance")]),s._v("服务。")]),s._v(" "),a("p",[s._v("我们需要保证，跨多个服务的步骤数据一致性：")]),s._v(" "),a("ol",[a("li",[s._v("微服务"),a("code",[s._v("pay")]),s._v("的支付宝表扣除 1 万")]),s._v(" "),a("li",[s._v("微服务"),a("code",[s._v("balance")]),s._v("的余额宝的表增加 1 万")])]),s._v(" "),a("blockquote",[a("p",[s._v("每个系统都对应一个独立的数据源，且可能位于不同机房，同时调用多个服务很难保证同时成功，这就是跨服务分布式事务的问题。")])]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("我们系统应该能保证每个服务自身的"),a("code",[s._v("ACID")]),s._v("，基于这个假设，我们事务消息解决分布式事务的问题。")])]),s._v(" "),a("h3",{attrs:{id:"事务消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务消息"}},[s._v("#")]),s._v(" 事务消息")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("在很多的麻辣烫的店，你点了份麻辣烫并付了钱，他们并不会直接把你点的东西给你，而是给你一个类似号码的手串给你，然后让你拿着号码牌到出货区排队去取。")]),s._v(" "),a("p",[s._v("为什么餐饮店要将付钱和取货 2 个动作分开呢？原因很多，其中一个很重要的原因是为了使他们的接待能力增加(程序里的说法就是并发量更高)。")]),s._v(" "),a("p",[s._v("只要这张号码牌在，你最终是能拿到麻辣烫的。同理，转账服务也是如此。")])]),s._v(" "),a("blockquote",[a("p",[s._v("当支付宝账户扣除 1 万元后，我们只要生成一个凭证(消息)即可，这个凭证(消息)上写着要余额宝增加 1 万，只要这个消息能可靠的保存，我们最终是可以拿到这个凭证(消息)让余额宝账号增加 1 万的，即我们能依靠这个凭证(消息)完成最终一致性。")])]),s._v(" "),a("h3",{attrs:{id:"如何保存可靠的消息凭证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何保存可靠的消息凭证"}},[s._v("#")]),s._v(" 如何保存可靠的消息凭证")]),s._v(" "),a("blockquote",[a("p",[s._v("要解决消息可靠存储，实际上需要解决的是本地的"),a("code",[s._v("mysql")]),s._v("存储和"),a("code",[s._v("message")]),s._v("存储的一致性问题。")])]),s._v(" "),a("p",[s._v("解决办法：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("Transactional outbox")])]),s._v(" "),a("li",[a("code",[s._v("Polling publisher")])]),s._v(" "),a("li",[a("code",[s._v("Transaction log tailing")])]),s._v(" "),a("li",[a("code",[s._v("2PC Message Queue")])])]),s._v(" "),a("p",[a("strong",[s._v("事务消息一旦被可靠的持久化，我们整个分布式事务，便完成了最终一致性，消息的消费才能保障最终业务数据的完整性，所以我们要尽最大努力，把消息送达到下游的业务消费方，成为"),a("code",[s._v("Best Effort")]),s._v("。只有消息被消费，整个交易才能算是完整完结。")])]),s._v(" "),a("h2",{attrs:{id:"待完结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#待完结"}},[s._v("#")]),s._v(" 待完结")])])}),[],!1,null,null,null);t.default=v.exports}}]);